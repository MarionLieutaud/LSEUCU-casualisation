---
title: "The crisis of academic casualisation at LSE: macro and comparative analyses"
author: "LSE UCU"
date: "2023-03-28"
output: 
  bookdown::pdf_document2:
    toc: true
    fig_caption: true
    latex_engine: xelatex
editor_options: 
  chunk_output_type: inline
urlcolor: blue
---

```{r, include = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)
```

```{r setup, include=FALSE}
library(tidyverse)
library(questionr)
library(stringr)
library(ggrepel)
library(ggtext)
library(forcats)
library(showtext)
library(hrbrthemes)
#hrbrthemes::import_roboto_condensed() # if need to download font
```

```{r graphicsthemes}
# theme for simple line plot
personal_theme_simple <- 
  theme_ipsum(base_size=9) +
  theme(plot.background = element_rect(fill = "white"),
        #panel.spacing.x = unit(0.5, "lines"),
        panel.grid.minor.y = element_blank(),
        axis.text.x = element_text(face = "bold",
                                   angle=30, 
                                   vjust=1, hjust= 1),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = ggtext::element_textbox_simple(size = 12),
        plot.subtitle = ggtext::element_textbox_simple(size = 9, face = "bold"),
        plot.caption.position = "plot",
        plot.caption = element_text(size = 7, face = "italic"),
        legend.position = "right",
        legend.text = element_text(size=10),
        legend.title = element_text(size=11))

# theme for proportionate change line plots
personal_theme_simple_propchange <- 
  theme_ipsum(base_size=9) +
  theme(plot.background = element_rect(fill = "white"),
        panel.spacing.x = unit(0.5, "lines"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.text.x = element_text(face = "bold", angle=30, vjust=1, hjust= 1),
        axis.title.x = element_blank(),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        plot.title = ggtext::element_textbox_simple(size = 12),
        plot.subtitle = ggtext::element_textbox_simple(size = 7, face = "bold"),
        plot.caption = element_text(size = 7, face = "italic"),
        legend.position = "right",
        legend.text = element_text(size=10),
        legend.title = element_text(size=11))

# theme for flipped barplot
personal_theme_flipped_barplot <- 
  theme_ipsum(base_size=9) +
  theme(plot.background = element_rect(fill = "white"),
        panel.spacing.x = unit(0.5, "lines"),
        panel.grid.minor.y = element_blank(),
        axis.text.y = element_text(size = 11, face = "bold"),
        axis.line.y.left = element_line(color = "black"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 12, face="bold", margin = margin(0,0,11,0)),
        plot.subtitle = element_text(size = 10, margin = margin(0,0,13,0)),
        plot.caption = element_text(size = 7, face = "italic"),
        legend.position = "bottom",
        legend.text = element_text(size=8),
        legend.title = element_blank())

# theme for facetted plots
personal_theme_simple_facets <- 
  theme_ipsum(base_size=9) +
  theme(plot.background = element_rect(fill = "white"),
        strip.text = element_text(face = "bold"),
        panel.grid.minor.y = element_blank(),
        axis.text.x = element_text(face = "bold",
                                   angle=30, 
                                   vjust=1, hjust= 1),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = ggtext::element_textbox_simple(size = 12),
        plot.subtitle = ggtext::element_textbox_simple(size = 9, face = "bold"),
        plot.caption.position = "plot",
        plot.caption = element_text(size = 7, face = "italic"),
        legend.position = "right",
        legend.text = element_text(size=10),
        legend.title = element_text(size=11))


# set extra colour as needed
BLUE <- "#076fa2"
```

\vspace{2cm}
All of the analyses run here are based on publicly-available data published by the Higher Education Statistics Agency (HESA).
This data can be directly downloaded on the HESA website: \href{https://www.hesa.ac.uk/data-and-analysis}{https://www.hesa.ac.uk/data-and-analysis}.
```{r dataimport1}
# Data import and binding
# I downloaded the HESA data then manually removed the data description from the csv files and added the relevant academic year to each file name. 

# Start with HESA data on fixed term and permanent staff
# available at https://www.hesa.ac.uk/data-and-analysis/staff/employment-conditions
data_files <- list.files("~/Dropbox (Personal)/LSE UCU/Casualisation data/HESA data/Permanent and fixed term staff by HE provider/") # path to data folder
HESA <- grep("HESA-dt025-table-7", data_files, value=TRUE) # HESA tables on fixed-term / permanent academic staff

#import all data files on fixed-term / permanent contracts
for(i in 1:length(HESA)) {                                                  
  assign(paste0("hesa_wave", (i+2013),"-",(i+2014)),                        # Read and store data frames into files called "hesa-wave[academic year]"
         read.csv(paste0("~/Dropbox (Personal)/LSE UCU/Casualisation data/HESA data/Permanent and fixed term staff by HE provider/",
                           HESA[i])) %>%
           mutate(date = paste0((i+2013),"-",(i+2014))))                    # Add a date variable to each data frame to identify academic years.
}


list_hesa <- list(`hesa_wave2014-2015`,
                  `hesa_wave2015-2016`,
                  `hesa_wave2016-2017`,
                  `hesa_wave2017-2018`,
                  `hesa_wave2018-2019`,
                  `hesa_wave2019-2020`,
                  `hesa_wave2020-2021`,
                  `hesa_wave2021-2022`)

hs <- bind_rows(list_hesa)

rm(`hesa_wave2014-2015`,
   `hesa_wave2015-2016`,
   `hesa_wave2016-2017`,
   `hesa_wave2017-2018`,
   `hesa_wave2018-2019`,
   `hesa_wave2019-2020`,
   `hesa_wave2020-2021`,
   `hesa_wave2021-2022`,
   list_hesa)
```


```{r dataimport2}
# same procedure with data on student enrollment
data_files <- list.files("~/Dropbox (Personal)/LSE UCU/Casualisation data/HESA data/Total students number by HE provider/") # path to data folder
HESA_students <- grep("dt051-table-1", data_files, value=TRUE) # HESA tables on students enrollment by HE provider

#import all data files on students enrollment overall
for(i in 1:length(HESA_students)) {                                                  
  assign(paste0("hesa_wave", (i+2013),"-",(i+2014)),                        # Read and store data frames into files called "hesa-wave[academic year]"
         read.csv(paste0("~/Dropbox (Personal)/LSE UCU/Casualisation data/HESA data/Total students number by HE provider/",
                           HESA_students[i])) %>%
           mutate(across(!HE.provider,~str_remove(.x, ","))) %>%
           mutate(across(!HE.provider, ~as.numeric(.x))) %>%
           mutate(date = paste0((i+2013),"-",(i+2014))))                    # Add a date variable to each data frame to identify academic years.
}


list_hesa <- list(`hesa_wave2014-2015`,
                  `hesa_wave2015-2016`,
                  `hesa_wave2016-2017`,
                  `hesa_wave2017-2018`,
                  `hesa_wave2018-2019`,
                  `hesa_wave2019-2020`,
                  `hesa_wave2020-2021`,
                  `hesa_wave2021-2022`)

he <- bind_rows(list_hesa) %>%
  select(c(HE.provider, Total, date)) # drop breakdown by gender of students. Keep only totals

rm(`hesa_wave2014-2015`,
   `hesa_wave2015-2016`,
   `hesa_wave2016-2017`,
   `hesa_wave2017-2018`,
   `hesa_wave2018-2019`,
   `hesa_wave2019-2020`,
   `hesa_wave2020-2021`,
   `hesa_wave2021-2022`,
   list_hesa)


```

```{r dataimport3}
# Same procedure for data on international and EU students
data_files <- list.files("~/Dropbox (Personal)/LSE UCU/Casualisation data/HESA data/Non-UK and EU student number/") # path to data folder
HESA_international_students <- grep("dt051-table-28", data_files, value=TRUE) # HESA tables on EU and international students enrollment by HE provider

for(i in 1:length(HESA_international_students)) {                                                  
  assign(paste0("hesa_wave", (i+2013),"-",(i+2014)),                        
         read.csv(paste0("~/Dropbox (Personal)/LSE UCU/Casualisation data/HESA data/Non-UK and EU student number/",
                           HESA_international_students[i])) %>%
           rename(HE.provider = HE.Provider,
                  Total_nonuk = Total) %>%
           mutate(across(!HE.provider,~str_remove(.x, ","))) %>%
           mutate(across(!HE.provider, ~as.numeric(.x))) %>%
           mutate(date = paste0((i+2013),"-",(i+2014))))                    
}

list_hesa <- list(`hesa_wave2014-2015`,
                  `hesa_wave2015-2016`,
                  `hesa_wave2016-2017`,
                  `hesa_wave2017-2018`,
                  `hesa_wave2018-2019`,
                  `hesa_wave2019-2020`,
                  `hesa_wave2020-2021`,
                  `hesa_wave2021-2022`)

hi <- bind_rows(list_hesa) %>%
  select(HE.provider, Total.European.Union, Total_nonuk, date)

rm(`hesa_wave2014-2015`,
   `hesa_wave2015-2016`,
   `hesa_wave2016-2017`,
   `hesa_wave2017-2018`,
   `hesa_wave2018-2019`,
   `hesa_wave2019-2020`,
   `hesa_wave2020-2021`,
   `hesa_wave2021-2022`,
   list_hesa)
```

```{r joindata}
h <- hs %>%
  left_join(he, by = c("HE.provider", "date")) %>%
  left_join(hi, by = c("HE.provider", "date")) %>%
  relocate(date, .after = HE.provider)

# h = full dataframe combining staff and student data
```


```{r recoding}
# data recoding and calculated variables
h <- h %>%
  mutate(across(4:9,~str_remove(.x, ","))) %>% # remove comas
  mutate(across(4:9, ~as.numeric(.x))) # treat all number-based variables as numeric

h <- h %>%
  mutate(ratio_permanent = Open.ended.Permanent/Fixed.term,
         ratio_casual = Fixed.term/Open.ended.Permanent,
         prop_permanent = (Open.ended.Permanent/Total.academic.staff)*100,
         prop_casual = (Fixed.term/Total.academic.staff)*100,
         staffstudent_ratio = Total/Open.ended.Permanent,
         prop_non_uk = round((Total_nonuk/Total)*100, digits=0),
         prop_eu = round((Total.European.Union/Total)*100, digits=0))


hs_2022 <- h %>% # roundabout & ugly way to get latest measures of casualisation
  filter(date == "2021-2022") %>%
  rename(latest_prop_casual_2022 = prop_casual) %>%
  select(HE.provider, latest_prop_casual_2022) 

h <- h %>%
  left_join(hs_2022, by = "HE.provider") 

rm(hs_2022) # tidy it out
```

```{r subset}
# group of unis in top QS 2022 rankings
h_subset_uni <- h %>%
  filter(HE.provider %in% c("London School of Economics and Political Science",
                            "The University of Oxford",
                            "The University of Cambridge",
                            "Imperial College of Science, Technology and Medicine",
                            "University College London",
                            "The University of Edinburgh",
                            "King's College London",
                            "The University of Warwick",
                            "The University of Bristol",
                            "The University of Glasgow")) %>%
  mutate(HE.provider.short = case_match(HE.provider,
                                       "London School of Economics and Political Science" ~ "LSE",
                                       "The University of Oxford" ~ "Oxford",
                                       "The University of Cambridge" ~ "Cambridge",
                                       "Imperial College of Science, Technology and Medicine" ~ "Imperial",
                                       "University College London" ~ "UCL",
                                       "The University of Edinburgh" ~ "Edinburgh",
                                       "King's College London" ~ "KCL",
                                       "The University of Warwick" ~ "Warwick",
                                       "The University of Bristol" ~ "Bristol",
                                       "The University of Glasgow" ~ "Glasgow"))

h_subset_uni <- h_subset_uni %>%
  mutate(colour1 = ifelse(HE.provider == "London School of Economics and Political Science", "darkred", "darkgrey"),
         colour2 = ifelse(HE.provider == "London School of Economics and Political Science", "darkred", "black"))
```
\newpage

# Casualisation of academic staff at LSE
```{r fixedandpermanentLSE, fig.showtext=TRUE, fig.cap="Number of permanent and fixed-term academic staff at LSE (HESA 2023)"}
h_lse <- h %>%
  filter(HE.provider %in% c("London School of Economics and Political Science")) 


h_lse_long <- pivot_longer(h_lse, cols = c(Open.ended.Permanent, Fixed.term),
                           names_to = "contract.type") %>%
  mutate(contract.type = case_match(contract.type, 
                                    "Fixed.term" ~ "fixed-term",
                                    "Open.ended.Permanent" ~ "permanent"))


p4 <- h_lse_long %>%
  ggplot(aes(x=date, y=value, group=contract.type)) +
  geom_point(aes(colour=contract.type)) +
  geom_line(aes(colour=contract.type)) +
  #scale_x_discrete(expand = expand_scale(mult = c(.05, .55))) +
  #scale_y_continuous(labels = scales::percent_format(scale = 1), breaks = seq(0,100,10), limits = c(0,100)) +
  scale_color_manual(values = c("darkred", "black"), name="Contract type: ") +
  labs(title = "Number of fixed-term and permanent academic staff at LSE",
       caption = "Source: HESA (annual data 2014-2022)") +
  personal_theme_simple

p4

#ggsave(p4, filename = "plot_HESA_nbstaff.png", width = 6.5, height = 4) # save plot
```



```{r permanentstaff, fig.showtext=TRUE, fig.dim= c(8,7), include = FALSE}
p1 <- h_subset_uni %>%
  ggplot(aes(x=date, y=prop_permanent, group=HE.provider, colour = colour1)) +
  geom_point() +
  geom_line() +
  scale_x_discrete(expand = expand_scale(mult = c(.05, .55))) +
  scale_y_continuous(labels = scales::percent_format(scale = 1), breaks = seq(0,100,10), limits = c(0,100)) +
  scale_colour_identity() +
  geom_text_repel(
    data = h_subset_uni %>% filter(date == "2021-2022"), 
    aes(label = HE.provider, group = colour2, colour = colour2),
    nudge_x = 0.2, hjust = 0, family = "Arial Narrow", fontface = "bold", size = 3,
    segment.color = "grey93", direction = "y") +
  labs(title = "Proportion of permanent staff among academic staff",
       caption = "Source: HESA (annual data 2014-2022) https://www.hesa.ac.uk/data-and-analysis/staff/employment-conditions.\n Calculation of permanent (open-ended contracts) staff as proportion or all academic staff.\n The nine comparators chosen are the universities above LSE in the 2022 QS Rankings (Oxford, Cambridge, Imperial, UCL, Edinburgh, KCL)\nand immediatley below it (Warwick, Bristol, Glasgow).") +
  personal_theme_simple
  
#p1

#ggsave(p1, filename = "plot_HESA_prop_permanent.png", width = 9, height = 7.5) # save plot
```

```{r casualstaff, fig.showtext=TRUE, fig.dim= c(8,7), fig.cap="Proportion of casual (fixed-term) staff amongst academic staff (HESA 2023)"}
p2 <- h_subset_uni %>%
  ggplot(aes(x=date, y=prop_casual, group=HE.provider.short, colour = colour1)) +
  geom_point() +
  geom_line() +
  scale_x_discrete(expand = expand_scale(mult = c(.05, .35))) +
  scale_y_continuous(labels = scales::percent_format(scale = 1), breaks = seq(0,100,10), limits = c(0,75)) +
  scale_colour_identity() +
  geom_text_repel(
    data = h_subset_uni %>% filter(date == "2021-2022"), 
    aes(label = paste0(HE.provider.short, ": ", round(latest_prop_casual_2022, digits=0), "%"), group = colour2, colour = colour2),
    nudge_x = 0.2, hjust = 0, family = "Arial Narrow", fontface = "bold", size = 3.5,
    segment.color = "grey93", direction = "y") +
  labs(title = "Proportion of fixed-term staff among academic staff",
       caption = "Source: HESA (annual data 2014-2022) https://www.hesa.ac.uk/data-and-analysis/staff/employment-conditions\nCalculation of fixed-term staff as a proportion or all academic staff.\nThe nine comparators chosen are the universities above LSE in the 2022 QS Rankings (Oxford, Cambridge, Imperial, UCL, Edinburgh, KCL)\nand immediatley below it (Warwick, Bristol, Glasgow).") +
  personal_theme_simple
  
p2

#ggsave(p2, filename = "plot_HESA_prop_casual.png", width = 6, height = 5) # save plot
```


\newpage
# Changes in permanent staff numbers and student-staff ratio
```{r permanentfall,fig.showtext=TRUE, fig.dim= c(8,7), fig.cap="Relative changes in permanent academic staff numbers since 2014-2015 (HESA 2023)"}
tab_wide <- h_subset_uni %>%
  group_by(HE.provider.short, date, Open.ended.Permanent) %>%
  summarise(n = n()) %>%
  pivot_wider(names_from = "date", values_from = "Open.ended.Permanent") %>%
  select(-n)

tab_wide2 <- tab_wide %>%
  mutate(diff_2015 = `2015-2016` - `2014-2015`,
         diff_2016 = `2016-2017` - `2015-2016`,
         diff_2017 = `2017-2018` - `2016-2017`,
         diff_2018 = `2018-2019` - `2017-2018`,
         diff_2019 = `2019-2020` - `2018-2019`,
         diff_2020 = `2020-2021` - `2019-2020`,
         diff_2021 = `2021-2022` - `2020-2021`,
         diff_overall = `2021-2022` - `2014-2015`)

tab_wide2 <- tab_wide2 %>%
  mutate(change_permanent2014 = 0,
         change_permanent2015 = (diff_2015/`2014-2015`)*100,
         change_permanent2016 = (diff_2016/`2015-2016`)*100,
         change_permanent2017 = (diff_2017/`2016-2017`)*100,
         change_permanent2018 = (diff_2018/`2017-2018`)*100,
         change_permanent2019 = (diff_2019/`2018-2019`)*100,
         change_permanent2020 = (diff_2020/`2019-2020`)*100,
         change_permanent2021 = (diff_2021/`2020-2021`)*100,
         change_permanentoverall = ((`2021-2022` - `2014-2015`) / `2014-2015`)*100) 

tab_permanentchange_print <- tab_wide2 %>%
  select(HE.provider.short, matches("^change_permanent")) %>%
  mutate(across(matches("change"), ~ round(.x, digits = 0)))

names(tab_permanentchange_print) <- c(names(tab_wide), "Overall")
#write_csv(tab_permanentchange_print, "tab_permanentchange.csv") # save table of percentage changes

tab_wide_cumul <- tab_wide2 %>%
  mutate(cum_change_permanent2014 = 0,
         cum_change_permanent2015 = change_permanent2015,
         cum_change_permanent2016 = cum_change_permanent2015 + change_permanent2016,
         cum_change_permanent2017 = cum_change_permanent2016 + change_permanent2017,
         cum_change_permanent2018 = cum_change_permanent2017 + change_permanent2018,
         cum_change_permanent2019 = cum_change_permanent2018 + change_permanent2019,
         cum_change_permanent2020 = cum_change_permanent2019 + change_permanent2020,
         cum_change_permanent2021 = cum_change_permanent2020 + change_permanent2021) %>%
  select(HE.provider.short, matches("cum_change"), matches("overall"))

tab_long_cumul <- tab_wide_cumul %>% 
  select(HE.provider.short, matches("change"), matches("overall")) %>%
  pivot_longer(cols = !c(HE.provider.short, diff_overall, change_permanentoverall),
    names_to = c("typechange", "year"),
    names_pattern = "(cum_change_permanent)(.*)$"
  ) %>%
  filter(!is.na(typechange)) %>%
  mutate(colour1 = ifelse(HE.provider.short == "LSE", "darkred", "darkgrey"),
         colour2 = ifelse(HE.provider.short == "LSE", "darkred", "black"),
         change_permanentoverall2 = ifelse(change_permanentoverall > 0, paste0("+", as.character(round(change_permanentoverall), digits=0)),
                                          as.character(round(change_permanentoverall), digits=0)),
         HE.overall = paste0(HE.provider.short,": ", change_permanentoverall2, "%"),
         HE.overall = ifelse(HE.provider.short == "LSE", paste0(HE.overall, "\nrelative to 2014 - 2015"), HE.overall))

p3 <- tab_long_cumul %>%
  ggplot(aes(x=year, y=value, group=HE.provider.short, colour = colour1)) +
  geom_point() +
  geom_line() +
  scale_x_discrete(labels = levels(as.factor(hs$date)),
                   expand = expand_scale(mult = c(.05, .45))) +
  scale_y_continuous() +
  scale_colour_identity() +
  geom_text_repel(
    data = tab_long_cumul %>% filter(year == "2021"), 
    aes(label = HE.overall, group = colour2, colour = colour2),
    nudge_x = 0.2, hjust = 0, family = "Arial Narrow", fontface = "bold", size = 3.5,
    segment.color = "grey93", direction = "y") +
  geom_richtext(aes(x = "2014", y = 10, family = "Arial Narrow",
                    label = "  baseline<br>= 0"),
                size = 3, fill = NA, label.color = NA, color = "darkgrey") +
  labs(title = "Proportionate changes in number of permanent academic staff",
       caption = "Source: HESA (annual data 2014-2022) https://www.hesa.ac.uk/data-and-analysis/staff/employment-conditions \nCalculation of yearly change in permanent staff as a percentage of the number of permanent staff the year before.\nChange starts from 0, corresponding to the 2014-2015 numbers of permanent staff, set as baseline.\nThe nine comparators chosen are the universities above LSE in the 2022 QS Rankings\n(Oxford, Cambridge, Imperial, UCL, Edinburgh, KCL) nand immediatley below it (Warwick, Bristol, Glasgow).") +
  personal_theme_simple_propchange
  
p3

#ggsave(p3, filename = "plot_HESA_cumul_permanent_change.png", width = 6, height = 5) # save plot
```

```{r plotstaffstudentratio, fig.showtext=TRUE, fig.dim= c(8,7), fig.cap="Student-to-staff ratio (permanent academic staff only) since 2014-2015, (HESA 2023)"}
p5 <- h_subset_uni %>%
  ggplot(aes(x=date, y=staffstudent_ratio, group=HE.provider.short, colour = colour1)) +
  geom_point() +
  geom_line() +
  scale_x_discrete(labels = levels(as.factor(hs$date)),
                   expand = expand_scale(mult = c(.05, .40))) +
  scale_y_continuous(breaks = seq(2,18, 2)) +
  scale_colour_identity() +
  geom_text_repel(
    data = h_subset_uni %>% filter(date == "2021-2022"), 
    aes(label = ifelse(HE.provider.short == "LSE", paste0(HE.provider.short,": ",staffstudent_ratio, " students per\npermanent staff member"),
                       HE.provider.short), 
        group = colour2, colour = colour2),
    nudge_x = 0.2, hjust = 0, family = "Arial Narrow", fontface = "bold", size = 3.5,
    segment.color = "grey93", direction = "y") +
  labs(title = "Student to permanent staff ratio",
       caption = "Source: HESA (annual data 2014-2022) https://www.hesa.ac.uk/data-and-analysis.\nThe nine comparators chosen are the universities above LSE in the 2022 QS Rankings\n(Oxford, Cambridge, Imperial, UCL, Edinburgh, KCL) and the three immediately below it (Warwick, Bristol, Glasgow).") +
  personal_theme_simple
  
p5

#ggsave(p6, filename = "plot_HESA_studentstaff_ratio.png", width = 6, height = 5) # save plot
```


\newpage
# Changes in student numbers and international students
```{r plotstudentnbchange, fig.showtext=TRUE, fig.dim= c(8,7), fig.cap = "Relative changes in student numbers since 2014-2015 (HESA 2023)"}
tab_wide <- h_subset_uni %>%
  group_by(HE.provider.short, date, Total) %>%
  summarise(n = n()) %>%
  pivot_wider(names_from = "date", values_from = "Total") %>%
  select(-n)

tab_wide2 <- tab_wide %>%
  mutate(diff_2015 = `2015-2016` - `2014-2015`,
         diff_2016 = `2016-2017` - `2015-2016`,
         diff_2017 = `2017-2018` - `2016-2017`,
         diff_2018 = `2018-2019` - `2017-2018`,
         diff_2019 = `2019-2020` - `2018-2019`,
         diff_2020 = `2020-2021` - `2019-2020`,
         diff_2021 = `2021-2022` - `2020-2021`,
         diff_overall = `2021-2022` - `2014-2015`)

tab_wide2 <- tab_wide2 %>%
  mutate(change_studentnb2014 = 0,
         change_studentnb2015 = (diff_2015/`2014-2015`)*100,
         change_studentnb2016 = (diff_2016/`2015-2016`)*100,
         change_studentnb2017 = (diff_2017/`2016-2017`)*100,
         change_studentnb2018 = (diff_2018/`2017-2018`)*100,
         change_studentnb2019 = (diff_2019/`2018-2019`)*100,
         change_studentnb2020 = (diff_2020/`2019-2020`)*100,
         change_studentnb2021 = (diff_2021/`2020-2021`)*100,
         change_studentnboverall = ((`2021-2022` - `2014-2015`) / `2014-2015`)*100) 

tab_change_studentnb_print <- tab_wide2 %>%
  select(HE.provider.short, matches("^change_studentnb")) %>%
  mutate(across(matches("change"), ~ round(.x, digits = 0)))

names(tab_change_studentnb_print) <- c(names(tab_wide), "Overall")
#write_csv(tab_change_studentnb_print, "tab_change_studentnb.csv") # save table of percentage changes

tab_wide_cumul <- tab_wide2 %>%
  mutate(cum_change_studentnb2014 = 0,
         cum_change_studentnb2015 = change_studentnb2015,
         cum_change_studentnb2016 = cum_change_studentnb2015 + change_studentnb2016,
         cum_change_studentnb2017 = cum_change_studentnb2016 + change_studentnb2017,
         cum_change_studentnb2018 = cum_change_studentnb2017 + change_studentnb2018,
         cum_change_studentnb2019 = cum_change_studentnb2018 + change_studentnb2019,
         cum_change_studentnb2020 = cum_change_studentnb2019 + change_studentnb2020,
         cum_change_studentnb2021 = cum_change_studentnb2020 + change_studentnb2021) %>%
  select(HE.provider.short, matches("cum_change"), matches("overall"))

tab_long_cumul <- tab_wide_cumul %>% 
  select(HE.provider.short, matches("change"), matches("overall")) %>%
  pivot_longer(cols = !c(HE.provider.short, diff_overall, change_studentnboverall),
    names_to = c("typechange", "year"),
    names_pattern = "(cum_change_studentnb)(.*)$"
  ) %>%
  filter(!is.na(typechange)) %>%
  mutate(colour1 = ifelse(HE.provider.short == "LSE", "darkred", "darkgrey"),
         colour2 = ifelse(HE.provider.short == "LSE", "darkred", "black"),
         change_studentnboverall2 = ifelse(change_studentnboverall > 0, paste0("+", as.character(round(change_studentnboverall), digits=0)),
                                          as.character(round(change_studentnboverall), digits=0)),
         HE.overall = paste0(HE.provider.short,": ", change_studentnboverall2, "%"),
         HE.overall = ifelse(HE.provider.short == "LSE", paste0(HE.overall, "\nrelative to 2014 - 2015"), HE.overall))

p6 <- tab_long_cumul %>%
  ggplot(aes(x=year, y=value, group=HE.provider.short, colour = colour1)) +
  geom_point() +
  geom_line() +
  scale_x_discrete(labels = levels(as.factor(hs$date)),
                   expand = expand_scale(mult = c(.05, .45))) +
  scale_y_continuous(name = "Proportionate yearly changes (cumulative)") +
  scale_colour_identity() +
  geom_text_repel(
    data = tab_long_cumul %>% filter(year == "2021"), 
    aes(label = HE.overall, group = colour2, colour = colour2),
    nudge_x = 0.2, hjust = 0, family = "Arial Narrow", fontface = "bold", size = 3.5,
    segment.color = "grey93", direction = "y") +
  geom_richtext(aes(x = "2014", y = 10, family = "Arial Narrow",
                    label = "  baseline<br>= 0"),
                size = 3, fill = NA, label.color = NA, color = "darkgrey") +
  labs(title = "Proportionate changes in student numbers since 2014-2015",
       caption = "Source: HESA (annual data 2014-2022) https://www.hesa.ac.uk/data-and-analysis/students\nCalculation of yearly change in student enrollment as a percentage of the number of students enrolled the year before.\nChange starts from 0, corresponding to the 2014-2015 student numbers, set as baseline.\nThe nine comparators chosen are the universities above LSE in the 2022 QS Rankings\n(Oxford, Cambridge, Imperial, UCL, Edinburgh, KCL) nand immediatley below it (Warwick, Bristol, Glasgow).") +
  personal_theme_simple_propchange
  
p6

#ggsave(p5, filename = "plot_HESA_studentsnb_change.png", width = 6, height = 5) # save plot
```

```{r, fig.showtext=TRUE, fig.dim= c(8,7), fig.cap= "Proportion of international students among all enrolled students, over time since 2014-2015 (HESA 2023)"}
p7 <- h_subset_uni %>%
  ggplot(aes(x=date, y=prop_non_uk, group=HE.provider.short, colour = colour1)) +
  geom_point() +
  geom_line() +
  scale_x_discrete(labels = levels(as.factor(hs$date)),
                   expand = expand_scale(mult = c(.05, .4))) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_colour_identity() +
  geom_text_repel(
    data = h_subset_uni %>% filter(date == "2021-2022"), 
    aes(label = ifelse(HE.provider.short == "LSE", paste0(HE.provider.short,": ",prop_non_uk, "%\ninternational students"),
                       paste0(HE.provider.short, ": ",prop_non_uk, "%")),
        group = colour2, colour = colour2),
    nudge_x = 0.2, hjust = 0, family = "Arial Narrow", fontface = "bold", size = 3.5,
    segment.color = "grey93", direction = "y") +
  labs(title = "Proportion of international students",
       caption = "Source: HESA (annual data 2014-2022) https://www.hesa.ac.uk/data-and-analysis.\nThe nine comparators chosen are the universities above LSE in the 2022 QS Rankings\n(Oxford, Cambridge, Imperial, UCL, Edinburgh, KCL) and the three immediately below it (Warwick, Bristol, Glasgow).") +
  personal_theme_simple
  
p7

#ggsave(p7, filename = "plot_HESA_nonUKstudent_ratio.png", width = 6, height = 5) # save plot
```


```{r barplotInternationalStudents, fig.showtext=TRUE, fig.dim= c(8,6), fig.cap="Proportion of EU students and non-EU international students among all students, in 2021-2022 (HESA 2023)"}
tab_int_long <- h_subset_uni %>% 
  filter(date == "2021-2022") %>%
  select(HE.provider.short, prop_non_uk, prop_eu) %>%
  mutate(prop_nonuk_noneu = prop_non_uk - prop_eu) %>%
  pivot_longer(cols = !c(HE.provider.short, prop_non_uk),
    names_to = c("prop")
  )


p8 <- ggplot(tab_int_long, aes(x=fct_reorder(HE.provider.short, value), y=value, fill = fct_rev(prop))) +
  geom_col(stat = "stacked", width = 0.6) +
  coord_flip() +
  scale_fill_manual(labels = c("Other international students", "EU students"),
                      values = c(BLUE, "lightblue")) +
  scale_y_continuous(breaks = seq(0, 70, by = 10),
                     expand = expand_scale(mult = c(0, .10)),
                     position = "right") +
  labs(title = "% of international students (EU + non-EU)",
       subtitle = "out of all enrolled students in 2021-2022",
       fill = NULL,
       caption = "Source: HESA (annual data 2014-2022) https://www.hesa.ac.uk/data-and-analysis.\n The percentage in white is the total proportion of non-UK students (EU + non-EU).\nThe nine comparators chosen are the universities above LSE in the 2022 QS Rankings\n(Oxford, Cambridge, Imperial, UCL, Edinburgh, KCL) and the three immediately below it (Warwick, Bristol, Glasgow).") +
  guides(fill = guide_legend(reverse = TRUE)) +
  personal_theme_flipped_barplot

# add labels outside bars
p8 <- p8 + geom_text(
    data = tab_int_long %>% filter(prop == "prop_nonuk_noneu"),
    aes(y=prop_non_uk, x = HE.provider.short, label = paste0(prop_non_uk, "%")),
    #vjust = 1,
    nudge_y = 2,
    colour = BLUE,
    family = "Arial Narrow",
    fontface = "bold",
    size = 4)

# add labels inside bars
p8 <- p8 + geom_text(
    data = tab_int_long %>% filter(prop == "prop_eu"),
    aes(y=value, x = HE.provider.short, label = paste0(value, "%")),
    #vjust = 1,
    nudge_y = -2,
    colour = BLUE,
    family = "Arial Narrow",
    fontface = "bold",
    size = 3)

p8

#ggsave(p9, filename = "plot_HESA_nonUKstudent_barplot.png", width = 6, height = 5) # save plot

```

\newpage
# LSE HR internal data
```{r}
library(openxlsx)
a <- loadWorkbook('~/Dropbox (Personal)/LSE UCU/Casualisation data/230323_UCU_TERMS_Data.xlsx')
sheetNames <- sheets(a)
for(i in 1:length(sheetNames))
{
  assign(sheetNames[i],readWorkbook(a,sheet = i))
}

hr <- Data # rename "Data" sheetname to "hr"
rm(Data) 

hr <- hr %>%
  rename("academic_year" = "Recid.Text",
         "level" = "Level.2.Long.Desc",
         "employment_terms" = "Terms.Text")
```



```{r fixedandpermanentLSEHR, fig.showtext=TRUE, fig.cap="Number of permanent and fixed-term academic staff at LSE (LSE HR internal data 2023)"}
hr <- hr %>%
  mutate(academic_year = str_remove(academic_year, " Staff record"), # keep only dates
         academic_year = str_replace(academic_year, "/", "-20"),
         staff_category = case_when(
           Staff.Type %in% c("Emeritus Teacher", "Extended Education", "Graduate Intern", "Support") ~ "Non-academic positions",
           Staff.Type == "Graduate Teaching Assistant" ~ "GTA (PhD students)",
           Staff.Type %in% c("Guest Teacher", "LSE fellows", "Policy", "Research", "Teaching", "Teaching and Research") ~ "Academic positions"),
         employment_terms2 = case_when(
           employment_terms %in% c("Fixed-term", "Open-ended/Subject to Funding") ~ "fixed-term",
           employment_terms == "Open-ended/Permanent" ~ "permanent"),
         employment_terms2 = factor(employment_terms2, levels = c("fixed-term", "permanent")),
         academic_employment = case_when(
           staff_category %in% c("Academic positions", "GTA (PhD students)") & employment_terms2 == "fixed-term" ~ "Academic (fixed-term)",
           staff_category == "Academic positions" & employment_terms2 == "permanent" ~ "Academic (permanent)"))

tab <- hr %>%
  filter(!staff_category == "Non-academic positions") %>%
  group_by(academic_year, academic_employment) %>%
  summarise(sum = sum(Headcount.Rounded))

tab <- tab %>%
  group_by(academic_year) %>%
  filter(!is.na(academic_employment)) %>%
  mutate(total_academic = sum(sum),
         total_casual_academic = sum[academic_employment == "Academic (fixed-term)"],
         prop_casual = (total_casual_academic/total_academic)*100) %>%
  ungroup() %>%
  add_row(academic_year = "2015-2016", .before=0) %>%
  add_row(academic_year = "2014-2015", .before=0)


p <- tab %>% ggplot(aes(x=academic_year, y=sum, group=academic_employment)) +
  geom_point(aes(colour=academic_employment)) +
  geom_line(aes(colour=academic_employment)) +
  scale_y_continuous(limits = c(690, 1040)) +
  scale_color_manual(values = c("darkred", "black"), name="Contract type: ", na.translate = F) +
  labs(title = "Number of fixed-term and permanent academic staff at LSE (LSE HR internal data)",
       caption = "Source: LSE internal HR data") +
  personal_theme_simple

p

#ggsave(p, filename = "plot_LSEHR_nbstaff.png", width = 6.5, height = 4) # save plot
```



```{r typepermanentacademic, fig.showtext=TRUE, fig.height=7, fig.width=6}
tab <- hr %>%
  filter(!staff_category == "Non-academic positions", academic_employment == "Academic (permanent)") %>%
  group_by(academic_year, Staff.Type) %>%
  summarise(sum = sum(Headcount.Rounded)) %>%
  ungroup() %>%
  add_row(academic_year = "2017-2018",  Staff.Type = "Guest Teacher", sum = 0, .before=0) %>%
  add_row(academic_year = "2016-2017",  Staff.Type = "Guest Teacher", sum = 0, .before=0)
# add rows with zero permanent positions for guest teachers prior to 2018-2019
# we assume it is zero since no guest teachers appear among permanent academic staff prior to 2018-2018

#lagged values to calculate change
tab <- tab %>%
  group_by(Staff.Type) %>%
  filter(!Staff.Type == "Policy") %>% # remove this empty category (there are no permanent Policy academics)
  mutate(sum_previous_year = lag(sum, n=1),
         absolute_change = sum - sum_previous_year,
         total_change = (sum[academic_year == "2021-2022"]) - (sum[academic_year == "2016-2017"]),
         categorical_change = case_when(
           absolute_change > 0 ~ "increase", 
           absolute_change == 0 ~ "no change",
           absolute_change < 0 ~ "decrease"),
         categorical_change = factor(categorical_change, levels = c("increase", "decrease", "no change")),
         staff_type = recode(Staff.Type,
                             "Guest Teacher" = "Guest teachers\n(permanent only)",
                             "Research" = "Research-only",
                             "Teaching" = "Teaching-only\n(Education-track)",
                             "Teaching and Research" = "Teaching and research"),
         staff_type = factor(staff_type, levels = c("Teaching and research",
                                                    "Guest teachers\n(permanent only)", 
                                                    "Research-only", 
                                                    "Teaching-only\n(Education-track)")))

#lollipop plot 1: year-by-year
lolliplot1 <- ggplot(tab, aes(x=academic_year, y=absolute_change, colour = categorical_change, group = staff_type)) +
  geom_hline(aes(yintercept=0), colour = "black") +
  geom_segment(aes(x=academic_year, xend=academic_year, y=0, yend=absolute_change, color = categorical_change)) +
  geom_point(aes(color=categorical_change), size=2) +
  facet_wrap(~ staff_type) +
  scale_color_manual(values = c("black", "red", "grey"), name="Change (absolute numbers)", na.translate = F) +
  scale_y_continuous(breaks = seq(-20, 20, by= 10)) +
  personal_theme_simple_facets +
  theme(legend.position = "none") +
  xlab("") +
  labs(title = "Yearly change (absolute terms) in permanent academic staff numbers by staff category (LSE HR internal data)",
       caption = "Source: LSE internal HR data (2023)")

lolliplot1

#ggsave(lolliplot1, filename = "lolliplot_LSEHR_changepermanentstaff.png", width = 6, height = 7) # save plot
```


```{r typepermanentacademic2, fig.showtext=TRUE, fig.height=6, fig.width=6}
# lollipop plot 2: change over the period
tab2 <- tab %>% filter(academic_year == "2021-2022") 

tab3 <- tab2 %>%
  ungroup() %>%
  add_row(staff_type = "All combined", total_change = sum(tab2$total_change)) %>%
  mutate(categorical_change = case_when(
           total_change > 0 ~ "increase", 
           total_change < 0 ~ "decrease"),
         categorical_change = factor(categorical_change, levels = c("increase", "decrease")),
         staff_type = factor(staff_type, levels = c("Teaching and research",
                                                    "Guest teachers\n(permanent only)", 
                                                    "Research-only", 
                                                    "Teaching-only\n(Education-track)",
                                                    "All combined")))


lolliplot2 <- ggplot(tab3, aes(x=staff_type, y=total_change, colour = categorical_change)) +
  geom_hline(aes(yintercept=0), colour = "black") +
  geom_segment(aes(x=staff_type, xend=staff_type, y=0, yend=total_change, color = categorical_change)) +
  geom_point(aes(color=categorical_change), size=2) +
  scale_color_manual(values = c("black", "red")) +
  scale_y_continuous(limits = c(-80, 50)) +
  personal_theme_simple +
  theme(legend.position = "none")+
  xlab("") +
  labs(title = "Overall change (absolute terms) in permanent academic staff numbers\nby staff category between 2016-2017 and 2021-2022",
       caption = "Source: LSE internal HR data (2023)") +
  geom_text(
    data = tab3,
    aes(y = ifelse(total_change > 0, total_change, (total_change -15)), 
        x = staff_type, 
        label = ifelse(total_change > 0, paste0("+", total_change), total_change), 
        colour = categorical_change),
    vjust = -1,
    #nudge_y = 2,
    family = "Arial Narrow",
    fontface = "bold",
    size = 4)


lolliplot2

#ggsave(lolliplot2, filename = "lolliplot_LSEHR_combinedchangepermanent.png", width = 5, height = 5) # save plot
```



\newpage
# LSE fellow and postdoc survey : survey description, results not yet disclosed

The 2022-2023 Postdoc and Fellow survey, conducted jointly by the LSE Fellows network and the UCU anti-casualisation officers, targeted all categories of post-doctoral fellows (LSE Fellows, Teaching Fellows, Research Fellows, Research Officers). 

In order to protect the respect the pledge of anonymity that was made to participants in the Postdoc and Fellow Survey, we are not sharing data or code for analysis here, and only include some of the most telling figures. 

```{r, fig.align='center', out.width="70%", include = TRUE}
knitr::include_graphics('~/Dropbox (Personal)/LSE UCU/Casualisation data/Q_future_plot.png')
```

